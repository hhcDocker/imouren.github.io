---
layout: post
title:  "mongodb"
date:   2016-11-12 09:15:31
categories: mongodb
tags: mongodb
---

* content
{:toc}

##  文档数据简介

memcached 和 redis 属于key-value数据库

传统数据库：存储的是结构化数据。

文档型数据库：反范式化，很灵活。

mongodb 属于文档型数据库，存储的是(bson--json的二进制化)

特点：内部执行引擎为JS解释器，把文档存储成bson结构；查询时，转换为JS对象，并可以通过js语法来操作。

它在磁盘上进行包装了一层，gridfs文件系统，在gridfs上是bson结构。

## 下载安装

去[官网](http://mongodb.org)下载最新稳定版

解压即可，不需要编译。

启动

```python
sudo  /usr/local/mongodb/bin/mongod --dbpath=/data/db --logpath=/var/log/mongodb/mongodb.log --fork

--dbpath 数据存储目录
--logpath 日志存储目录
--port 运行端口(默认27017)
--fork 后台进程运行

--smallfiles 占用小空间，可以在虚拟机上使用这个参数
```

客户端

```python

./mongo foo
./mongo 192.168.0.5/foo
./mongo 192.168.0.5:9999/foo

```

试着敲些命令

```python
MongoDB server version: 3.4.1

> show dbs;
admin  0.000GB
local  0.000GB
shop   0.000GB
> show databases;
admin  0.000GB
local  0.000GB
shop   0.000GB
> use admin;
switched to db admin
> show tables;
system.version

```


## 库表操作语句

查看库  show dbs; show databases;

选择库  use dbname;

查看库下面的collection  show collections; show tables;

查看帮助  db.help();

```python
> show dbs;
admin  0.000GB
local  0.000GB
shop   0.000GB
> show databases;
admin  0.000GB
local  0.000GB
shop   0.000GB

> use shop;
switched to db shop

> show collections;
user
> show tables;
user

```

创建数据库:  数据库是隐式创建的 直接用 use dbname;

创建collection：  db.createCollection("collection_name");

插入数据(也可以隐式创建collection)：  db.collection_name.insert(document);

"_id"是自动生成的，也可以自己指定

mysql表限制了结构，而mongo不需要限制，所以可以隐式创建

查看数据：  db.collection_name.find();

删除collection:  db.collection_name.drop();

删除数据库:  db.dropDatabase();


```python
> use newdb;
switched to db newdb

> db.createCollection("auser");
{ "ok" : 1 }
> show dbs;
admin  0.000GB
local  0.000GB
newdb  0.000GB
shop   0.000GB
> show tables;
auser

> db.auser.insert({name: "lisi", age:22})
WriteResult({ "nInserted" : 1 })

# 隐式创建collection
> db.buser.insert({name: "lisi", age:22})
WriteResult({ "nInserted" : 1 })
> show tables;
auser
buser

> db.auser.find()
{ "_id" : ObjectId("587482341b173ff4b3f9600c"), "name" : "lisi", "age" : 22 }

# 指定 _id
> db.auser.find()
{ "_id" : ObjectId("587482341b173ff4b3f9600c"), "name" : "lisi", "age" : 22 }
{ "_id" : 1, "name" : "mr" }

# 删除collection
> show tables;
auser
buser
> db.buser.drop();
true
> show tables;
auser

# 删除库
> db.dropDatabase();
{ "dropped" : "newdb", "ok" : 1 }
> show dbs;
admin  0.000GB
local  0.000GB
shop   0.000GB
```

## CURD操作

增加操作

```python

> use test;
switched to db test
# 单篇文档
> db.student.insert({sn: '001', name: "xiaoming"});
WriteResult({ "nInserted" : 1 })
> db.student.find();
{ "_id" : ObjectId("5874925d1b173ff4b3f9600e"), "sn" : "001", "name" : "xiaoming" }

# 单篇文档 自定义ID
> db.student.insert({_id: 2, sn: '002', name: "xiaohong"});
WriteResult({ "nInserted" : 1 })
> db.student.find();
{ "_id" : ObjectId("5874925d1b173ff4b3f9600e"), "sn" : "001", "name" : "xiaoming" }
{ "_id" : 2, "sn" : "002", "name" : "xiaohong" }

# 一次增加多个文档
> db.student.insert([{sn: '003', name: "hehe"}, {sn:'004', name: "haha"}, {_id: 5, sn:"005", name:"xixi"}]);
BulkWriteResult({
        "writeErrors" : [ ],
        "writeConcernErrors" : [ ],
        "nInserted" : 3,
        "nUpserted" : 0,
        "nMatched" : 0,
        "nModified" : 0,
        "nRemoved" : 0,
        "upserted" : [ ]
})
> db.student.find();
{ "_id" : ObjectId("5874925d1b173ff4b3f9600e"), "sn" : "001", "name" : "xiaoming" }
{ "_id" : 2, "sn" : "002", "name" : "xiaohong" }
{ "_id" : ObjectId("5874930d1b173ff4b3f9600f"), "sn" : "003", "name" : "hehe" }
{ "_id" : ObjectId("5874930d1b173ff4b3f96010"), "sn" : "004", "name" : "haha" }
{ "_id" : 5, "sn" : "005", "name" : "xixi" }
```

删除

db.collection_name.remove(查询表达式，选项);

选项是指  {justOne:true/false},是否只删一行, 默认为false

1: 查询表达式依然是个json对象
2: 查询表达式匹配的行,将被删掉.
3: 如果不写查询表达式,collections中的所有文档将被删掉


```python
# 删除 sn属性值为'001'的文档
> db.student.remove({sn: '001'});
WriteResult({ "nRemoved" : 1 })


> db.student.find();
{ "_id" : 2, "sn" : "002", "name" : "xiaohong" }
{ "_id" : ObjectId("5874930d1b173ff4b3f9600f"), "sn" : "003", "name" : "hehe" }
{ "_id" : ObjectId("5874930d1b173ff4b3f96010"), "sn" : "004", "name" : "haha" }
{ "_id" : 5, "sn" : "005", "name" : "xixi" }
{ "_id" : ObjectId("5874958f1b173ff4b3f96011"), "sn" : "100", "gender" : "m" }
{ "_id" : ObjectId("5874958f1b173ff4b3f96012"), "sn" : "101", "gender" : "m" }

# gender属性为m的文档
> db.student.remove({gender:'m'});
WriteResult({ "nRemoved" : 2 })
> db.student.insert([{sn:'100', gender: 'm'}, {sn:'101', gender: 'm'}])
BulkWriteResult({
        "writeErrors" : [ ],
        "writeConcernErrors" : [ ],
        "nInserted" : 2,
        "nUpserted" : 0,
        "nMatched" : 0,
        "nModified" : 0,
        "nRemoved" : 0,
        "upserted" : [ ]
})

# gender属性为m的文档,只删除1行
> db.student.remove({gender:'m'}, true);
WriteResult({ "nRemoved" : 1 })

# 删除所有
> db.student.remove({});
WriteResult({ "nRemoved" : 5 })
```


修改操作

db.collection_name.update(查询表达式,新值,选项);

默认修改是新文档替换旧文档

修改文档的某列,可以用$set关键字

修改时的赋值表达式

```python
$set  修改某列的值
$unset 删除某个列
$rename 重命名某个列
$inc 增长某个列
$setOnInsert 当upsert为true时,并且发生了insert操作时,可以补充的字段.

```

选项  {upsert:true/false,multi:true/false}

upsert  没有匹配的行，则直接插入改行
multi  是否改多行，默认false

测试代码

```python

> db.student.insert({sn: "001", name: "xiaoming", gender: "m"})
WriteResult({ "nInserted" : 1 })
> db.student.find();
{ "_id" : ObjectId("587498f6f96e5844e80ff4f6"), "sn" : "001", "name" : "xiaoming", "gender" : "m" }

# 修改
> db.student.update({name:"xiaoming"}, {name:"wangxiaoming"})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
# 注意：新文档整体替换旧文档，而不是修改 gender属性没有了
> db.student.find();
{ "_id" : ObjectId("587498f6f96e5844e80ff4f6"), "name" : "wangxiaoming" }


> db.student.remove({})
WriteResult({ "nRemoved" : 1 })
> db.student.insert({sn: "001", name: "xiaoming", gender: "m"})
WriteResult({ "nInserted" : 1 })

# 使用$set 可以是修改
> db.student.update({name:"xiaoming"}, {$set: {name:"wangxiaoming"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "m" }

# 插入测试数据
> db.student.insert({sn: "003", name: "aa", sex: "m", age:11})
WriteResult({ "nInserted" : 1 })
> db.student.insert({sn: "004", name: "bb", gender: "m", age:22})
WriteResult({ "nInserted" : 1 })

# 修改名字 删除sn 重命名字段sex 自增age
> db.student.update({name: "aa"}, {$set:{name: "AA"}, $unset: {sn: "003"}, $rename: {"sex":"gender"}, $inc: {age: 3}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "m" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "m" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "m", "age" : 22 }

# 选项的测试 默认一行
> db.student.update({gender:"m"}, {$set: {gender: "male"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "male" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "m" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "m", "age" : 22 }
# 修改多行
> db.student.update({gender:"m"}, {$set: {gender: "male"}}, {multi:true})
WriteResult({ "nMatched" : 2, "nUpserted" : 0, "nModified" : 2 })
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "male" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "male" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "male", "age" : 22 }


# upsert
> db.student.update({name: "xxx"}, {$set: {gender: "male"}}, {upsert:true})
WriteResult({
        "nMatched" : 0,
        "nUpserted" : 1,
        "nModified" : 0,
        "_id" : ObjectId("5874a152dafd87c0793701b5")
})
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "male" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "male" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "male", "age" : 22 }
{ "_id" : ObjectId("5874a152dafd87c0793701b5"), "name" : "xxx", "gender" : "male" }


$setOnInsert 当upsert为true时,并且发生了insert操作时,可以补充的字段
> db.student.update({name: "zzzz"}, {$set: {gender: "male"}, $setOnInsert: {age: 23}}, {upsert:true})
WriteResult({
        "nMatched" : 0,
        "nUpserted" : 1,
        "nModified" : 0,
        "_id" : ObjectId("5874a1bddafd87c0793701bd")
})
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "male" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "male" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "male", "age" : 22 }
{ "_id" : ObjectId("5874a152dafd87c0793701b5"), "name" : "xxx", "gender" : "male" }
{ "_id" : ObjectId("5874a1bddafd87c0793701bd"), "name" : "zzzz", "gender" : "male", "age" : 23 }
```


查询

db.collection.findOne(查询表达式,查询的列);

db.collection.find(查询表达式,查询的列);

db.collection.find(查询表达式,查询的列).limit(n);

db.collection.find(查询表达式,查询的列).limit(n).skip(m);

```python
# 查询一个内容
> db.student.findOne();
{
        "_id" : ObjectId("58749a43f96e5844e80ff4f7"),
        "sn" : "001",
        "name" : "wangxiaoming",
        "gender" : "male"
}

# 查询所有内容
> db.student.find();
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "sn" : "001", "name" : "wangxiaoming", "gender" : "male" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA", "age" : 14, "gender" : "male" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "sn" : "004", "name" : "bb", "gender" : "male", "age" : 22 }
{ "_id" : ObjectId("5874a152dafd87c0793701b5"), "name" : "xxx", "gender" : "male" }
{ "_id" : ObjectId("5874a1bddafd87c0793701bd"), "name" : "zzzz", "gender" : "male", "age" : 23 }

# 查询指定列，默认包含 _id
> db.student.find({}, {name:1});
{ "_id" : ObjectId("58749a43f96e5844e80ff4f7"), "name" : "wangxiaoming" }
{ "_id" : ObjectId("58749d6df96e5844e80ff4f8"), "name" : "AA" }
{ "_id" : ObjectId("58749d73f96e5844e80ff4f9"), "name" : "bb" }
{ "_id" : ObjectId("5874a152dafd87c0793701b5"), "name" : "xxx" }
{ "_id" : ObjectId("5874a1bddafd87c0793701bd"), "name" : "zzzz" }
# 不包括_id
> db.student.find({}, {name:1, _id:0});
{ "name" : "wangxiaoming" }
{ "name" : "AA" }
{ "name" : "bb" }
{ "name" : "xxx" }
{ "name" : "zzzz" }

# 指定条件查询
> db.student.find({age:23}, {name:1, _id:0});
{ "name" : "zzzz" }
```

## 深入查询表达式

### 准备些数据

```python
> db.goods.insert([your_data]);

> db.goods.count();
31
```

### 进行一些查询

* 简单的查询表达式  {field: value}

* != 查询表达式  {field: {$ne: value}}

* > < >= <= 表达式    {field: {$XX: value}} 对应的XX为 gt lt gte lte

* in not_in 表达式 {field: {$in: [v1, v2, ...]}} {field: {$nin: [v1, v2, ...]}} 

* $all 数组内均匹配才可以  {field: {$all: [v1, v2, ...]}} 

* and or nor(所有均不满足) 表达式  {$and: {条件1, 条件2, ..}} {$or: {条件1, 条件2, ..}} {$nor: {条件1, 条件2, ..}}

* $not 不单独使用，跟其他操作符一起使用

* $exists 存在列为真 {field: $exists:1/0}

* $mod 取模值匹配为真 {field: $mod: [5, 0]} }

* $type 某列的类型  {field: {$type: type}}  Double:1 String:2 Object:3 Array:4 ...

* $where 将BSON转为json进行查询的，可以处理字段的比较等  { $where: "sql" }

* $regex 正则表达式 Perl兼容的正则表达式 {field: {$regex: reg, $options: op}}  /reg/op
   
   其中options  i:大小写不敏感 m:字符串可以多行 s:.可以匹配换行 x:可以包含注释

* $slice 操作符控制查询返回的数组中元素的个数 也可以使用[ skip , limit ] 格式

* elemMatch 投影操作符将限制查询返回的数组字段的内容只包含匹配elemMatch

    多个元素匹配$elemMatch条件，操作符返回数组中第一个匹配条件的元素

```python
# 查询主键为32的商品
db.goods.find({"goods_id":32});

# 查询类目为3的商品，只显示类目ID、商品ID、商品名称
db.goods.find({"cat_id": {$ne: 3}}, {"cat_id": 1, "goods_id": 1, "goods_name":1});

# 高于三千元的商品
db.goods.find({"shop_price": {$gt: 3000}}, {"shop_price": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 不高于三千元的商品
db.goods.find({"shop_price": {$lte: 3000}}, {"shop_price": 1, "goods_id": 1, "goods_name":1, "_id": 0});

db.goods.find({"shop_price": {$not: {$gt: 3000}}}, {"shop_price": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 类目为4或者11的商品
db.goods.find({"cat_id": {$in: [4, 11]}}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 类目不为4或者11的商品
db.goods.find({"cat_id": {$nin: [4, 11]}}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 价格在100和500之间的商品
db.goods.find({$and: [{"shop_price": {$gt: 100}}, {"shop_price": {$lt: 500}}]}, {"shop_price": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 不属于类目3且不属于类目11的商品 $and 
db.goods.find({$and: [{"cat_id": {$ne: 3}}, {"cat_id": {$ne: 11}}]}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

db.goods.find({"cat_id": {$nin: [3, 11]}}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

db.goods.find({$nor: [{"cat_id": 3}, {"cat_id": 11}]}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 商品ID是5的倍数的
db.goods.find({"goods_id": {$mod: [5, 0]}}, {"goods_id": 1, "goods_name":1, "_id": 0});

# 存在年龄列的
db.student.find({"age": {$exists: 1}})

# 学号存储为double类型的
db.student.find({"sn": {$type: 1}})

# 存在列且为null
db.users.find({sex:{$in:[null], $exists:true }})

# 分类ID大于等于商品ID的
db.goods.find({$where: "this.cat_id >= this.goods_id"}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 分类ID等于商品ID的
db.goods.find({$where: "this.cat_id == this.goods_id"}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# 物品名称三星开头的
db.goods.find({"goods_name": /^三星.*/}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

db.goods.find({"goods_name": {$regex: "^三星"}}, {"cat_id": 1, "goods_id": 1, "goods_name":1, "_id": 0});

# slice的用法
> db.student.find({sn:22})
{ "_id" : ObjectId("5880807ef96e5844e80ff51a"), "sn" : 22, "hobby" : [ "a", "b", "c", "d", "e" ] }
> db.student.find({sn:22}, {"hobby": {$slice:3}})
{ "_id" : ObjectId("5880807ef96e5844e80ff51a"), "sn" : 22, "hobby" : [ "a", "b", "c" ] }
> db.student.find({sn:22}, {"hobby": {$slice:-3}})
{ "_id" : ObjectId("5880807ef96e5844e80ff51a"), "sn" : 22, "hobby" : [ "c", "d", "e" ] }
> db.student.find({sn:22}, {"hobby": {$slice:[1,4]}})
{ "_id" : ObjectId("5880807ef96e5844e80ff51a"), "sn" : 22, "hobby" : [ "b", "c", "d", "e" ] }


# elemMatch用法
> db.school.find();
{ "_id" : 1, "zipcode" : 63109, "students" : [ { "name" : "john", "school" : 102, "age" : 10 }, { "name" : "jess", "school" : 102, "age" : 11 }, { "name" : "jeff", "school" : 108, "age" : 15 } ] }
{ "_id" : 2, "zipcode" : 63110, "students" : [ { "name" : "ajax", "school" : 100, "age" : 7 }, { "name" : "achilles", "school" : 100, "age" : 8 } ] }
{ "_id" : 3, "zipcode" : 63109, "students" : [ { "name" : "ajax", "school" : 100, "age" : 7 }, { "name" : "achilles", "school" : 100, "age" : 8 } ] }
{ "_id" : 4, "zipcode" : 63109, "students" : [ { "name" : "barney", "school" : 102, "age" : 7 } ] }
# 查询 例子
> db.school.find( { zipcode: 63109 },{ students: { $elemMatch: { school: 102 } } } );
{ "_id" : 1, "students" : [ { "name" : "john", "school" : 102, "age" : 10 } ] }
{ "_id" : 3 }
{ "_id" : 4, "students" : [ { "name" : "barney", "school" : 102, "age" : 7 } ] }
```

